<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plyr with HLS and DASH Support</title>
    <!-- Plyr CSS -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
</head>
<body>
    <!-- Video Player Container -->
    <video id="video-player" controls crossorigin playsinline></video>

    <!-- Plyr JS -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <!-- HLS.js (for HLS support) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- DASH.js (for DASH support) -->
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>

    <script>
        // Function to get URL parameters
        function getURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                videoUrl: urlParams.get('video'),   // Extract 'video' parameter (URL)
                format: urlParams.get('format'),    // Extract 'format' parameter ('hls' or 'dash')
                quality: urlParams.get('quality')  // Extract 'quality' parameter (for DASH)
            };
        }

        // Get the URL parameters
        const params = getURLParams();
        console.log('Video URL:', params.videoUrl);  // For debugging
        console.log('Format:', params.format);      // For debugging
        console.log('Quality:', params.quality);    // For debugging

        // Initialize the video element and Plyr
        const video = document.getElementById('video-player');
        const player = new Plyr(video);

        // Handle quality switching
        function handleQualitySwitch(format, qualityIndex) {
            if (format === 'hls' && Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(params.videoUrl);  // Load HLS stream URL
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    if (qualityIndex !== undefined) {
                        hls.startLevel = qualityIndex; // Set quality level
                        hls.loadSource(params.videoUrl); // Reload stream with quality change
                    }
                });
            } else if (params.format === 'dash') {
                const dash = dashjs.MediaPlayer().create();
                dash.initialize(video, params.videoUrl, true);  // Initialize with auto quality switch

                // Optional: Change quality for DASH (based on the 'quality' URL parameter)
                if (qualityIndex !== undefined) {
                    dash.setQualityFor('video', qualityIndex); // Set the quality index
                }
            }
        }

        // Check the format (either HLS or DASH)
        if (params.format === 'hls') {
            // If format is HLS, use HLS.js for playback
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(params.videoUrl);  // Load HLS stream URL
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    console.log('HLS manifest loaded');
                    
                    // Populate quality levels dropdown (HLS)
                    const qualityLevels = hls.levels;
                    const qualitySelect = document.createElement('select');
                    qualityLevels.forEach((level, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `Quality ${level.height || level.width}`;
                        qualitySelect.appendChild(option);
                    });
                    qualitySelect.addEventListener('change', (e) => {
                        const selectedQualityIndex = parseInt(e.target.value);
                        handleQualitySwitch('hls', selectedQualityIndex);
                    });
                    document.body.appendChild(qualitySelect);  // Append dropdown to body
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Fallback for browsers that natively support HLS (like Safari)
                video.src = params.videoUrl;
            }
        } else if (params.format === 'dash') {
            // If format is DASH, use DASH.js for playback
            const dash = dashjs.MediaPlayer().create();
            dash.initialize(video, params.videoUrl, true);  // true enables auto-switching between qualities

            // Optional: Populate quality levels dropdown (DASH)
            dash.on(dashjs.MediaPlayer.events.MANIFEST_LOADED, function() {
                const availableQualities = dash.getBitrateInfoListFor('video');
                const qualitySelect = document.createElement('select');
                availableQualities.forEach((quality, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `Quality ${quality.height}p`;
                    qualitySelect.appendChild(option);
                });
                qualitySelect.addEventListener('change', (e) => {
                    const selectedQualityIndex = parseInt(e.target.value);
                    dash.setQualityFor('video', selectedQualityIndex);
                });
                document.body.appendChild(qualitySelect);  // Append dropdown to body
            });
        } else {
            console.error('Unsupported format. Please provide "hls" or "dash" format.');
        }

        // Optional: Handle errors for HLS.js
        if (params.format === 'hls' && Hls.isSupported()) {
            const hls = new Hls();
            hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                    console.error('HLS.js error:', data);
                    alert('An error occurred while loading the video.');
                }
            });
        }

        // Optional: Handle errors for DASH.js
        if (params.format === 'dash') {
            const dash = dashjs.MediaPlayer().create();
            dash.on(dashjs.MediaPlayer.events.ERROR, function (e) {
                console.error('DASH.js error:', e);
                alert('An error occurred while loading the video.');
            });
        }

    </script>
</body>
</html>
